<!DOCTYPE html>
<html>
<head>
  <title>EarthData Sender - WebSocket</title>
  <style>
    body { 
      font-family: Arial;
      max-width: 800px; 
      margin: 50px auto; 
      padding: 20px; 
    }
    .status { 
      padding: 20px; 
      margin: 20px 0; 
      border-radius: 8px; 
      font-size: 20px; 
      text-align: center; 
      border: 2px solid #ddd; 
    }
    .connected { 
      background: #d4edda; 
      border-color: #28a745; 
      color: #155724; 
    }
    .waiting { 
      background: #fff3cd; 
      border-color: #ffc107; 
      color: #856404; 
    }
    input[type="file"] { 
      margin: 10px 0; 
    }
    button { 
      padding: 12px 24px; 
      font-size: 16px; 
      margin: 5px; 
      cursor: pointer; 
    }
    #log { 
      background: #000; 
      color: #0f0; 
      padding: 15px; 
      height: 300px; 
      overflow-y: auto; 
      font-family: monospace; 
      margin-top: 20px; 
      font-size: 13px; 
    }
  </style>
</head>
<body>
  <h1>EarthData Sender</h1>
  <div class="status waiting" id="status">Ready</div>

  <input type="text" id="serverUrl" value="ws://localhost:8080/" style="width:100%;" placeholder="Server URL">
  <input type="file" id="fileInput" accept=".bin">
  <button onclick="startBroadcast()" id="sendBtn" disabled>Start Broadcasting</button>

  <div id="log"></div>

<script>
let ws = null;
let fileData = null;
let frameCount = 0;
const CHUNK_SIZE = 16384;

function log(msg) {
  const div = document.getElementById('log');
  const t = new Date().toLocaleTimeString();
  div.innerHTML += `[${t}] ${msg}\n`;
  div.scrollTop = div.scrollHeight;
  console.log(msg);
}

document.getElementById('fileInput').addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    fileData = ev.target.result;
    log(`✓ File loaded: ${file.name} (${(fileData.byteLength/1024/1024).toFixed(2)} MB)`);
    document.getElementById('sendBtn').disabled = false;
  };
  reader.readAsArrayBuffer(file);
});

function startBroadcast() {
  const serverUrl = document.getElementById('serverUrl').value;
  ws = new WebSocket(serverUrl);
  ws.binaryType = "arraybuffer";

  ws.onopen = () => {
    log('✓ Connected to server');
    document.getElementById('status').textContent = 'Waiting for receiver...';
    ws.send(JSON.stringify({ type: "register", role: "sender" }));
  };

  ws.onmessage = event => {
    const msg = typeof event.data === "string" ? JSON.parse(event.data) : null;
    if (msg?.type === "paired") {
      log('✓ Paired with receiver');
      document.getElementById('status').textContent = '✓ Paired - Broadcasting frames';
      sendFrame();
    }
  };

  ws.onclose = () => log('Disconnected');
}

function sendFrame() {
  if (!fileData) return;
  frameCount++;
  const totalChunks = Math.ceil(fileData.byteLength / CHUNK_SIZE);
  let offset = 0;
  for (let i = 0; offset < fileData.byteLength; i++, offset += CHUNK_SIZE) {
    const header = new Uint32Array([frameCount, i, totalChunks]);
    ws.send(header.buffer);
    const chunk = fileData.slice(offset, offset + CHUNK_SIZE);
    ws.send(chunk);
  }
  log(`Frame ${frameCount} sent (${totalChunks} chunks)`);
  setTimeout(sendFrame, 100); // 10fps
}
</script>
</body>
</html>
