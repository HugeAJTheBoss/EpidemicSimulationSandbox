<!DOCTYPE html>
<html>
<head>
  <title>EarthData Receiver - WebSocket</title>
  <style>
    body { 
      font-family: Arial; 
      max-width: 800px; 
      margin: 50px auto; 
      padding: 20px; 
    }
    .status { 
      padding: 20px; 
      margin: 20px 0; 
      border-radius: 8px; 
      font-size: 20px; 
      text-align: center; 
      border: 2px solid #ddd; 
    }
    .connected { 
      background: #d4edda; 
      border-color: #28a745; 
      color: #155724; 
    }
    .waiting { 
      background: #fff3cd; 
      border-color: #ffc107; 
      color: #856404; 
    }
    #log { 
      background: #000; 
      color: #0f0; 
      padding: 15px; 
      height: 300px; 
      overflow-y: auto; 
      font-family: monospace;
      margin-top: 20px; 
      font-size: 13px; 
    }
  </style>
</head>
<body>
<h1>EarthData Receiver</h1>
<div class="status waiting" id="status">Connecting...</div>
<input type="text" id="serverUrl" value="ws://localhost:8080/" style="width:100%;" placeholder="Server URL">
<div id="log"></div>

<script>
let ws = null;
let currentFrame = null;
let receivedChunks = [];
let expectedChunks = 0;
let expectingHeader = true;

function log(msg) {
  const div = document.getElementById('log');
  const t = new Date().toLocaleTimeString();
  div.innerHTML += `[${t}] ${msg}\n`;
  div.scrollTop = div.scrollHeight;
  console.log(msg);
}

window.onload = connect;

function connect() {
  const serverUrl = document.getElementById('serverUrl').value;
  ws = new WebSocket(serverUrl);
  ws.binaryType = "arraybuffer";

  ws.onopen = () => {
    log("✓ Connected to server");
    ws.send(JSON.stringify({ type: "register", role: "receiver" }));
  };

  ws.onmessage = event => {
    if (typeof event.data === "string") {
      const msg = JSON.parse(event.data);
      if (msg.type === "paired") {
        log("✓ Paired with sender");
        document.getElementById('status').textContent = '✓ Paired - Receiving frames';
        document.getElementById('status').className = 'status connected';
      }
      return;
    }

    handleBinary(event.data);
  };

  ws.onclose = () => {
    log('Disconnected, reconnecting in 3s...');
    setTimeout(connect, 3000);
  };
}

function handleBinary(data) {
  if (expectingHeader) {
    const h = new Uint32Array(data);
    currentFrame = h[0];
    expectedChunks = h[2];
    receivedChunks = [];
    expectingHeader = false;
  } else {
    receivedChunks.push(new Uint8Array(data));
    if (receivedChunks.length === expectedChunks) {
      reassembleFrame();
    }
    expectingHeader = true;
  }
}

function reassembleFrame() {
  const totalSize = receivedChunks.reduce((sum, c) => sum + c.length, 0);
  const complete = new Uint8Array(totalSize);
  let offset = 0;
  for (const chunk of receivedChunks) {
    complete.set(chunk, offset);
    offset += chunk.length;
  }
  log(`Frame ${currentFrame}: ${totalSize.toLocaleString()} bytes complete`);

  if (currentFrame === 1) downloadAsFile(complete.buffer, 'received_earthdata.bin');
  receivedChunks = [];
}

function downloadAsFile(buf, filename) {
  const blob = new Blob([buf], { type: 'application/octet-stream' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename;
  a.click(); URL.revokeObjectURL(url);
}
</script>
</body>
</html>
